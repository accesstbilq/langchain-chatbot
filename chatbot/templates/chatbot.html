<!DOCTYPE html>
<html lang="en">
    <head>
        {% load static %}
        <meta charset="UTF-8">
        <title>Chat with Bot</title>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    </head>
    <body>
        
        <div class="menublock">
            <ul>
                <li class="active"><a href="/">Chatbot</a></li>
                <li><a href="/chathistory/">Chat History</a></li>
                <li><a href="/document/">Manage Document</a></li>
            </ul>
        </div>
        <div class="main-container" style="height: calc(100vh - 150px);">
            <!-- MetaData Container -->
             
            <div class="metadata-comtainer" id="metadata_comtainer">
                <div class="chat-header">
                    MetaData
                </div>
                <div class="metadata">



                </div>
            </div>
            <!-- Chat Section -->
            <div class="chat-section">
                <div class="chat-container">
                    <div class="chat-header">
                        Chat with New Bot
                    </div>
                    <div class="chat-box" id="chat-box"></div>
                    <!-- Loader shown while waiting for bot -->
                    <div id="loader" class="loader"></div>
                    <div class="chat-input">
                        <input type="text" id="user-input" placeholder="Type a message..." onkeydown="if(event.key === 'Enter') sendMessage()">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
            
        </div>

        <script>
            const sessionId = 'session--' +
                            randomStr(8) + '-' +
                            randomStr(4) + '-' +
                            randomStr(4) + '-' +
                            randomStr(4) + '-' +
                            randomStr(12);
            $(document).ready(function(){
                loadwelcomemessage();
            })

            function loadwelcomemessage(){
                $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                let result = "";
                const decoder = new TextDecoder();
                $('#loader').show();
                const agentChatDiv = document.createElement("div");
                agentChatDiv.className = "message bot";
                document.querySelector(".chat-box").appendChild(agentChatDiv);
                fetch('/streaming-welcome/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                }).then(response => {
                    $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                    const reader = response.body.getReader();
                    function read() {
                        reader.read().then(({ done, value }) => {
                            if (done) return;

                            const chunk = decoder.decode(value, { stream: true });
                            result += chunk;
                            agentChatDiv.innerHTML += chunk.replace(/\n/g, "<br>");
                            scrollToBottom();
                            read();
                        });
                    }
                    read();
                }).catch(error => {
                    $('#chat-box').append('<div class="message bot">❌ Error: ' + error.message + '</div>');
                }).finally(() => {
                    $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                    $('#loader').hide();
                });

            }

            function scrollToBottom() {
                const scrollableDiv = document.getElementById('chat-box');
                scrollableDiv.scrollTop = scrollableDiv.scrollHeight;
            }
            function randomStr(len) {
                return Array.from(crypto.getRandomValues(new Uint8Array(len)))
                    .map(n => (n % 36).toString(36))
                    .join('');
            }

            // Enhanced: hide loader AFTER metadata returns; robust in all branches
            async function sendMessage() {
                const userInput = $('#user-input').val().trim();
                if (!userInput) return;

                const chatBox = document.getElementById('chat-box'); // ✅ use the same target everywhere
                const decoder = new TextDecoder();

                // Append user message
                $('#chat-box').append('<div class="message user">You: ' + $('<div>').text(userInput).html() + '</div>');
                scrollToBottom();

                $('#user-input').val('');
                $('#loader').show();

                // Create bot message container
                const agentChatDiv = document.createElement('div');
                agentChatDiv.className = 'message bot';
                chatBox.appendChild(agentChatDiv);
                scrollToBottom();

                try {
                    const resp = await fetch('/chat-input/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userInput, session_id: sessionId })
                    });

                    if (!resp.ok || !resp.body) {
                        throw new Error(`HTTP ${resp.status}`);
                    }

                    const reader = resp.body.getReader();
                    let result = '';

                    // Stream loop
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });
                        result += chunk;
                        agentChatDiv.innerHTML += chunk.replace(/\n/g, '<br>');
                        scrollToBottom();
                    }

                    // ✅ Only hide loader after metadata finishes (if we fetch it)
                    if (sessionId) {
                        try {
                            const metaResp = await fetch(`/get-token-usage/${sessionId}/`);
                            if (!metaResp.ok) throw new Error(`HTTP ${metaResp.status}`);
                            const data = await metaResp.json();

                            const metadataHtml = `
                                <p>Response Type: ${data.response_type ?? ''}</p>
                                <p>Source: ${data.source ?? ''}</p>
                                <p>Total Tokens: ${data.total_tokens ?? ''}</p>
                                <p>Input Tokens: ${data.input_tokens ?? ''}</p>
                                <p>Output Tokens: ${data.output_tokens ?? ''}</p>
                                <p>Session Id: ${data.session ?? ''}</p>
                                <p>Run Id: ${data.run_id ?? ''}</p>
                            `;
                            $('.metadata').html(metadataHtml);
                        } catch (e) {
                            console.error('Failed to fetch token usage', e);
                        } finally {
                            $('#loader').hide(); // hide after metadata attempt completes
                        }
                    } else {
                        $('#loader').hide(); // no metadata to fetch
                    }
                } catch (error) {
                    $('#chat-box').append('<div class="message bot">❌ Error: ' + $('<div>').text(error.message).html() + '</div>');
                    scrollToBottom();
                    $('#loader').hide(); // make sure loader never gets stuck
                }
            }
        </script>
    </body>
</html>