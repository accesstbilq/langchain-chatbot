<!DOCTYPE html>
<html lang="en">
    <head>
        {% load static %}
        <meta charset="UTF-8">
        <title>Chat with Bot</title>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    </head>
    <body>
        <div class="main-container">
            <!-- MetaData Container -->
            <div class="metadata-comtainer" id="metadata_comtainer">
                <div class="chat-header">
                    MetaData
                </div>
                <div class="metadata"></div>
            </div>
            <!-- Chat Section -->
            <div class="chat-section">
                <div class="chat-container">
                    <div class="chat-header">
                        Chat with New Bot
                    </div>
                    <div class="chat-box" id="chat-box"></div>
                    <!-- Loader shown while waiting for bot -->
                    <div id="loader" class="loader"></div>
                    <div class="chat-input">
                        <input type="text" id="user-input" placeholder="Type a message..." onkeydown="if(event.key === 'Enter') sendMessage()">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
            
        </div>

        <script>

            const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            // Original sendMessage function (preserved and enhanced)
            function sendMessage() {
                const userInput = $('#user-input').val().trim();
                

                let result = "";
                const decoder = new TextDecoder();


                //if (!userInput) return;

                $('#chat-box').append('<div class="message user">You: ' + userInput + '</div>');
                $('#user-input').val('');
                $('#loader').show();
                const agentChatDiv = document.createElement("div");
                agentChatDiv.className = "message bot";
                document.querySelector(".chat-box").appendChild(agentChatDiv);
                fetch('/chat-input/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: userInput,session_id: sessionId })
                }).then(response => {
                    // const runId = response.headers.get('x-run-id');
                    // console.log('x-run-id:', runId);
                    
                    // // You can store it in a variable or use it as needed
                    // // For example, store it globally or in a data attribute
                    // window.currentRunId = runId;
                    const reader = response.body.getReader();
                    function read() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                //✅ When done streaming, get token usage
                                if (sessionId) {
                                    $.get(`/get-token-usage/${sessionId}/`, function(data) {
                                        console.log("Token usage:", data);
                                        // You can display this in your UI
                                        let metadataHtml = `
                                                <p>Response Type: ${data.response_type}</p>
                                                <p>Source: ${data.source}</p>
                                                <p>Total Tokens: ${data.total_tokens}</p>
                                                <p>Input Tokens: ${data.input_tokens}</p>
                                                <p>Output Tokens: ${data.output_tokens}</p>
                                                <p>Session Id: ${data.session}</p>
                                                <p>Run Id: ${data.run_id}</p>
                                            `;
                                            $('.metadata').html(metadataHtml);
                                    }).fail(err => {
                                        console.error("Failed to fetch token usage", err);
                                    });
                                }
                                return;
                            }
                            const chunk = decoder.decode(value, { stream: true });
                            result += chunk;
                            agentChatDiv.innerHTML += chunk.replace(/\n/g, "<br>");
                            read();
                        });
                    }
                    read();
                }).catch(error => {
                    $('#chat-box').append('<div class="message bot">❌ Error: ' + error.message + '</div>');
                }).finally(() => {
                    $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                    $('#loader').hide();
                });
            }
        </script>
    </body>
</html>